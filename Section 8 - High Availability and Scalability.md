# Section 8 - High Availability and Scalability

## 1-High Availability and Scalability


`Vertical Scalability` (scaling out / in)
- vertically scalability means increasing the size of the instance
- ie. .t2.micro -> t2.large
- i.e. RDS and ElastiCache's underlying servers can be scaled

`Horizontal Scalability`
- increasing the number of instances / systems for an application
- distributed system
- ASG
- load balancer

`High Availability` 
- goes hand in hand with horizontal scaling
- running your application in at least 2 data centers (== 2+ Availability Zones)
- goal of high availability is to survive a data center loss
- ASG multi AZ
- load balancer multi AZ


## 2-Elastic Load Balancing (ELB)

- spread load across multiple downstream instances
- expose a single point of access to your application
	- NLBs: one static IP address per AZ/EIP OK
	- ALB & CLB have static DNS  `EXAM`
- seamlessly handle downstream failures
- health checks
- provide SSL termination (HTTPS) for your websites
- Enforce stickiness with cookies
- high availability across zones
- separate public traffic from private traffic


- ELB is `managed` by AWS
	- takes care of upgrades, maintenance, high availability
	- provides a few configuration knobs
- well integrated

### Health Checks
- performed on a port and a route
- i.e. port 4567 /health

## Types of load balancers
1) `Classic Load Balancer` not recommended  / old
2) `Application Load Balancer` ALB - HTTP, HTTPS, WebSocket
3) `Network Load Balancer` NLB - TCP, TLS, UDP
4) `Gateway Load Balancer` - GWLB - IP Protocol

## Security
- Port 80 & 443 allow TCP connections in (Load balancer allows all traffic pretty much)
- EC2 instance then just allows inbound traffic from the source load balancer


## 3-1) Application Load Balancer

- Layer 7 (meaning HTTP)
- Load balances multiple HTTP applications across target groups
- can be via instances or containers
- supports HTTP/HTTPS/WebSocket protocol

- Can route based on URL i.e. /users vs /posts
- Can route based on hostname in URL one.example.com vs other.example.com
- Routing based on query string, headers etc. example.com/user?id=123

- ALB are a great fit for micro services & container based applications

ALB target groups can be:
- ec2 instances
- ECS tasks 
- Lambda functions
- private IPs

Health checks are the target group level


## Good to know
- given fixed hostname XXX.region.elb.amazonaws.com
- application servers dont see the IP of the client directly
	- the true IP of the client is inserted in the `X-Forwarded-For` headers

## 4-2) Network Load Balancer

- Layer 4
- Forward `TCP` and `UDP` traffic to your instances `EXAM`
- Once forwarded various protocols are allowed outbound towards the target groups (i.e. TCP in, HTTP out)
- ultra low latency
- for each AZ you want to use there is one static IP address assigned by AWS/or EIP `EXAM` (NLP ONLY)

- NLB has `one static IP per AZ` and supports assigning Elastic IP

- NLB: extreme performance, TCP, UDP think NLB

## Target Group
- EC2 instances
- Private IP addresses
- can have an NLB in front of an ALB (i.e. get fixed IP addresses from the NLB, then all the routing rules for the ALB)


## 5)-3) Gateway Load Balancer

- Layer 3 (lower level than the others) - IP packets
- all traffic of your network to go through a fire wall, deep packet inspection system, payload manipulation, prevention systems, intrusion detection
- the use case basically is to allow traffic to be analyzed before continuing to your application

- Combines the following functions
	- transparent network gateway - single entry/exit for all traffic
	- load balancer - distributes traffic to your virtual appliances

`EXAM` uses `GENEVE` protocol on port `6081`

### Target groups
- ec2 instance

## 7-ELB Sticky Sessions


- possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
- works for Classic Load Balancer, Application Load Balancer, Network Load Balancer
- uses cookies
- use case: make sure the user doesn't lose their session data
- enabling stickiness can unbalance your load


Two types of a`pplication based cookies`
- `custom cookie`
	- generated by the target
	- can include any custom
- `application cookie`
	- generated by the load balancer


`Duration-based cookies`
- cookie generated by the load balancer


## 8-ELB Cross Zone Load Balancing


- each load balancer instance distributes evenly across all registered instances in all AZ
- will balance traffic downstream regardless of what AZ the target (EC2 instance) is

Can enable or disable this, without this if your targets as unbalanced by AZ you get unbalanced traffic


### Application load balancer
- enabled by default (can disable at the target group level)
- no charge for inter AZ data (normally you do pay for cross AZ traffic)

### NLB & GWLB
- disabled by default
- will pay & if you enable it


### Classic LB
- disabled by default

## 9-ELB SSL Certificates


### SSL/TLS - Basics
- SSL cert allows traffic between client and your load balancer to be encrypted in transit (in-flight enryption)
- SSL: Secure Socket Layer used to encrypt
- TLS: Transport Layer Security (new more adopted version) often still called SSL

- SSL certs are issued by Certificate Authorities (CA)
- Comodo, Symantec, GoDaddy etc.

- SSL certs have an expiration date (you set) & must be renewed

### Load Balancer - SSL Certs
- Load balancer uses X.509 cert (SSL/TLS server cert)
- Can manage certs using ACM (AWS certificate Manager)
- Can create your own certs if you want
- need HTTPS listener:
	- specify default cert
	- optional list of certs for multiple domains
	- clients can use SNI (server name indication) to specify the hostname they reach
	- ability to specify a security policy to support older versions of SSL/TLS (legacy)


### Server Name Indication (SNI) `EXAM`
- solves problem of loading multiple SSL certs onto one web server
- new protocol requires the client to INDICATE the hostname of the target server in the initial SSL handshake
- The server will then find the correct cert or return the default one


Only works for ALB, NLB, and CloudFront


## 10-Elastic Load Balancer - Connection Draining



- Feature naming
- connection draining for CLB
- de registration delay for ALB and NLB

- Time to complete "in flight requests" while the instance is de-registering or unhealthy
- stop sending new requests to the EC2 instance which is de-registering


## 11-Auto Scaling Groups (ASG)

- load can change over time
- can create and quickly get rid of server
- can automate this using an ASG
	- scale out / horizontally scale to match an increased load
	- scale in (remove EC2 instance) to match a decreased load
	- can define minimum and maximum
	- automatically register new instances to a load baalncer
	- unhealthy instances can be automatically terminated

ASGs are free
- only pay for underlying resources


To use ASGs
- must create a launch template
- i.e.
- AMI, instance types
- EC2 user data
- ebs volumes
- security groups
- SSH key pairs
- IAM roles
- network + subnets
- load balancer information


## 12-Auto Scaling Group Scaling Policies

- Dynamic Scaling
	- target tracking scaling (think average)
		- simple to setup
		- i.e. I want the average ASG CPU to stay around 40%
	- simple / step scaling
		- when CPU > 70% then add 2 units
		- when below 30% remove 1
	- scheduled scaling
		- anticipate based on known patterns
		- i.e. fridays scale out
	- predictive scaling
		- continuously forecast load and schedule scaling ahead

Good metrics to scale on
- CPUUtilization (average)
- RequestCountPerTarget
- Average Network In / Out (if app is network bound)
- or any custom CloudWatch metric


Scaling Cooldowns
- after a scaling activity ASG will not scale anymore for a set time
- default 300 seconds
